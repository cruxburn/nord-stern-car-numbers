{% extends "base.html" %}

{% block title %}Search - Nord Stern Car Numbers{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-search me-2"></i> Search & Manage Car Numbers</h5>
            </div>
            <div class="card-body">
                <ul class="nav nav-tabs" id="searchTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="search-tab" data-bs-toggle="tab" data-bs-target="#search-panel" type="button" role="tab">
                            <i class="fas fa-search"></i> Search
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="results-tab" data-bs-toggle="tab" data-bs-target="#results-panel" type="button" role="tab">
                            <i class="fas fa-table"></i> Results
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="actions-tab" data-bs-toggle="tab" data-bs-target="#actions-panel" type="button" role="tab">
                            <i class="fas fa-tools"></i> Actions
                        </button>
                    </li>
                </ul>
                
                <div class="tab-content" id="searchTabsContent">
                    <div class="tab-pane fade show active" id="search-panel" role="tabpanel">
                        <div class="row">
                            <div class="col-md-8">
                                <h6 class="fw-bold text-primary mb-3">Search Options</h6>
                                <form action="{{ url_for('search') }}" method="get" class="row g-4">
                                    <div class="col-md-6">
                                        <label for="searchQuery" class="form-label">Search by Driver Name</label>
                                        <input type="text" class="form-control" id="searchQuery" name="q" value="{{ query }}" placeholder="Enter driver name...">
                                    </div>
                                    <div class="col-md-3">
                                        <label for="searchNumber" class="form-label">Search by Car Number</label>
                                        <input type="number" class="form-control" id="searchNumber" name="number" value="{{ number }}" placeholder="Enter car number...">
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">&nbsp;</label>
                                        <button type="submit" class="btn btn-primary w-100">
                                            <i class="fas fa-search me-2"></i> Search
                                        </button>
                                    </div>
                                </form>
                            </div>
                            <div class="col-md-4">
                                <h6 class="fw-bold text-primary mb-3">Quick Actions</h6>
                                <div class="d-grid gap-2">
                                                                    <a href="{{ url_for('search', show_all='1') }}" class="btn btn-outline-secondary">
                                    <i class="fas fa-list me-2"></i> Show All
                                </a>
                                    <a href="{{ url_for('add_registration') }}" class="btn btn-outline-success">
                                        <i class="fas fa-plus me-2"></i> Add New
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="tab-pane fade" id="results-panel" role="tabpanel">
                        {% if registrations %}
                        <div class="row">
                            <div class="col-12">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h6 class="fw-bold text-primary mb-0">Search Results ({{ registrations|length }} found)</h6>
                                    <a href="{{ url_for('add_registration') }}" class="btn btn-success">
                                        <i class="fas fa-plus me-2"></i> Add New
                                    </a>
                                </div>
                                <div class="table-responsive">
                                    <table class="table table-striped table-hover mb-0">
                                        <thead class="table-dark">
                                            <tr>
                                                <th class="px-4 py-3" style="width: 8%;">Car #</th>
                                                <th class="px-4 py-3" style="width: 20%;">Driver Name</th>
                                                <th class="px-4 py-3" style="width: 18%;">Car Details</th>
                                                <th class="px-4 py-3" style="width: 12%;">Reserved</th>
                                                <th class="px-4 py-3" style="width: 10%;">Expiration</th>
                                                <th class="px-4 py-3" style="width: 12%;">Usage</th>
                                                <th class="px-4 py-3" style="width: 10%;">Status</th>
                                                <th class="px-4 py-3 text-center" style="width: 10%;">Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for reg in registrations %}
                                            <tr>
                                                <td class="px-4 py-3">
                                                    <span class="badge bg-primary fs-6">{{ reg[3] }}</span>
                                                </td>
                                                <td class="px-4 py-3 text-nowrap">
                                                    <strong>{{ reg[1] }} {{ reg[2] }}</strong>
                                                    {% if query and (query.lower() in reg[1].lower() or query.lower() in reg[2].lower()) %}
                                                        <span class="badge bg-warning text-dark ms-2">‚Üê Matched</span>
                                                    {% endif %}
                                                </td>
                                                <td class="px-4 py-3">
                                                    {% if reg[5] or reg[6] or reg[7] or reg[8] %}
                                                        <small class="text-muted">
                                                            {% if reg[5] %}<strong>{{ reg[5] }}</strong>{% endif %}
                                                            {% if reg[6] %} {{ reg[6] }}{% endif %}
                                                            {% if reg[7] %} ({{ reg[7] }}){% endif %}
                                                            {% if reg[8] %} - {{ reg[8] }}{% endif %}
                                                        </small>
                                                    {% else %}
                                                        <span class="text-muted fst-italic">No car details</span>
                                                    {% endif %}
                                                </td>
                                                <td class="px-4 py-3">
                                                    {% if reg[9] %}
                                                        <small class="text-muted">
                                                            {% set date_parts = reg[9].split('-') %}
                                                            {% if date_parts|length == 3 %}
                                                                {{ date_parts[1] }}/{{ date_parts[2] }}/{{ date_parts[0] }}
                                                            {% else %}
                                                                {{ reg[9] }}
                                                            {% endif %}
                                                        </small>
                                                    {% else %}
                                                        <span class="text-muted fst-italic">Not specified</span>
                                                    {% endif %}
                                                </td>
                                                <td class="px-4 py-3">
                                                    {% if reg[14] %}
                                                        {% set date_parts = reg[14].split('-') %}
                                                        {% if date_parts|length == 3 %}
                                                            {% set expiration_year = date_parts[0] %}
                                                        {% else %}
                                                            {% set expiration_year = reg[14] %}
                                                        {% endif %}
                                                        <span class="badge bg-success" title="Expires in {{ expiration_year }}">{{ expiration_year }}</span>
                                                    {% else %}
                                                        <span class="text-muted fst-italic">Not set</span>
                                                    {% endif %}
                                                </td>
                                                <td class="px-4 py-3">
                                                    {% if reg[13] %}
                                                        <small class="text-muted">
                                                            Last: {{ reg[13] }}<br>
                                                            Count: {{ reg[15] or 0 }}
                                                        </small>
                                                    {% else %}
                                                        <span class="text-muted fst-italic">No usage</span>
                                                    {% endif %}
                                                </td>
                                                <td class="px-4 py-3">
                                                    {% if reg[11] == 'Active' %}
                                                        {% if reg[16] %}
                                                            <span class="badge bg-success">Active</span>
                                                        {% else %}
                                                            <span class="badge bg-warning text-dark">Expired</span>
                                                        {% endif %}
                                                    {% elif reg[11] == 'Retired' %}
                                                        <span class="badge bg-secondary">Retired</span>
                                                    {% else %}
                                                        <span class="badge bg-warning text-dark">{{ reg[11] or 'Unknown' }}</span>
                                                    {% endif %}
                                                </td>
                                                <td class="px-4 py-3 text-center">
                                                    <div class="btn-group" role="group">
                                                        <a href="{{ url_for('edit_registration', id=reg[0]) }}" class="btn btn-outline-primary btn-sm" title="Edit">
                                                            <i class="fas fa-edit"></i>
                                                        </a>
                                                        <button type="button" class="btn btn-outline-success btn-sm" title="Record Usage" 
                                                                onclick="showUsageModal({{ reg[0] }}, '{{ reg[1] }} {{ reg[2] }}', '{{ reg[3] }}')">
                                                            <i class="fas fa-calendar-check"></i>
                                                        </button>
                                                        {% if reg[15] and reg[15] > 0 %}
                                                        <form method="POST" action="{{ url_for('remove_usage', id=reg[0]) }}" style="display: inline;">
                                                            <button type="submit" class="btn btn-outline-warning btn-sm" title="Remove Usage" 
                                                                    onclick="return confirm('Remove usage for {{ reg[1] }} {{ reg[2] }} (Car #{{ reg[3] }})?')">
                                                                <i class="fas fa-calendar-times"></i>
                                                            </button>
                                                            <!-- Hidden fields to preserve search context -->
                                                            <input type="hidden" name="search_query" value="{{ query }}">
                                                            <input type="hidden" name="search_number" value="{{ number }}">
                                                            <input type="hidden" name="search_show_all" value="{{ show_all }}">
                                                        </form>
                                                        {% endif %}
                                                        <button type="button" class="btn btn-outline-danger btn-sm" title="Delete" 
                                                                onclick="confirmDelete({{ reg[0] }}, '{{ reg[1] }} {{ reg[2] }}', '{{ reg[3] }}')">
                                                            <i class="fas fa-trash"></i>
                                                        </button>
                                                    </div>
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        {% elif query or number %}
                        <div class="row">
                            <div class="col-12">
                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle me-2"></i> No registrations found matching your search criteria.
                                    <a href="{{ url_for('add_registration') }}" class="alert-link fw-bold">Add a new registration</a> or try a different search.
                                </div>
                            </div>
                        </div>
                        {% else %}
                        <div class="row">
                            <div class="col-12 text-center">
                                <i class="fas fa-search fa-3x text-muted mb-3"></i>
                                <h6 class="fw-bold text-muted">No Search Performed</h6>
                                <p class="text-muted">Use the search form above to find registrations.</p>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                    
                    <div class="tab-pane fade" id="actions-panel" role="tabpanel">
                        <div class="row">
                            <div class="col-md-6">
                                <h6 class="fw-bold text-primary mb-3">Registration Management</h6>
                                <div class="d-grid gap-3">
                                    <a href="{{ url_for('add_registration') }}" class="btn btn-success">
                                        <i class="fas fa-plus me-2"></i> Add New Registration
                                    </a>
                                    <a href="{{ url_for('search') }}?q=&show_all=1" class="btn btn-outline-primary">
                                        <i class="fas fa-list me-2"></i> View All Registrations
                                    </a>
                                    <a href="{{ url_for('stats') }}" class="btn btn-outline-info">
                                        <i class="fas fa-chart-bar me-2"></i> View Statistics
                                    </a>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <h6 class="fw-bold text-primary mb-3">Quick Search</h6>
                                <div class="d-grid gap-3">
                                    <a href="{{ url_for('search') }}?q=&show_all=1" class="btn btn-outline-secondary">
                                        <i class="fas fa-list me-2"></i> Browse All
                                    </a>
                                    <a href="{{ url_for('search') }}?status=Active" class="btn btn-outline-success">
                                        <i class="fas fa-check-circle me-2"></i> Active Only
                                    </a>
                                    <a href="{{ url_for('search') }}?status=Expired" class="btn btn-outline-danger">
                                        <i class="fas fa-clock me-2"></i> Expired Only
                                    </a>
                                    <a href="{{ url_for('search') }}?status=Retired" class="btn btn-outline-warning">
                                        <i class="fas fa-times-circle me-2"></i> Retired Only
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title fw-bold">
                    <i class="fas fa-exclamation-triangle text-warning me-2"></i>Confirm Delete
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete the registration for <strong id="deleteDriverName"></strong> (Car #<span id="deleteCarNumber"></span>)?</p>
                <p class="text-danger fw-bold"><small>This action cannot be undone.</small></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <form id="deleteForm" method="post" style="display: inline;">
                    <button type="submit" class="btn btn-danger">
                        <i class="fas fa-trash me-2"></i>Delete
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Record Usage Modal -->
<div class="modal fade" id="usageModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title fw-bold">
                    <i class="fas fa-calendar-check text-success me-2"></i>Record Usage
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Record usage for <strong id="usageDriverName"></strong> (Car #<span id="usageCarNumber"></span>)</p>
                <form id="usageForm" method="post">
                    <div class="mb-3">
                        <label for="usageYear" class="form-label">Usage Year</label>
                        <select class="form-select" id="usageYear" name="usage_year" required>
                            <option value="">Select year...</option>
                            {% for year in range(2020, 2030) %}
                            <option value="{{ year }}" {% if year == 2025 %}selected{% endif %}>{{ year }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <!-- Hidden fields to preserve search context -->
                    <input type="hidden" name="search_query" value="{{ query }}">
                    <input type="hidden" name="search_number" value="{{ number }}">
                    <input type="hidden" name="search_show_all" value="{{ show_all }}">
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" form="usageForm" class="btn btn-success">
                    <i class="fas fa-calendar-check me-2"></i>Record Usage
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function confirmDelete(id, driverName, carNumber) {
    document.getElementById('deleteDriverName').textContent = driverName;
    document.getElementById('deleteCarNumber').textContent = carNumber;
    document.getElementById('deleteForm').action = '/delete/' + id;
    
    var deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));
    deleteModal.show();
}

function showUsageModal(id, driverName, carNumber) {
    document.getElementById('usageDriverName').textContent = driverName;
    document.getElementById('usageCarNumber').textContent = carNumber;
    document.getElementById('usageForm').action = '/api/record_usage/' + id;
    
    var usageModal = new bootstrap.Modal(document.getElementById('usageModal'));
    usageModal.show();
}

function showAllRegistrations() {
    // Switch to Results tab and show all registrations
    const resultsTab = document.querySelector('#results-tab');
    const resultsPanel = document.querySelector('#results-panel');
    
    if (resultsTab && resultsPanel) {
        // Remove active class from all tabs and content
        document.querySelectorAll('.nav-link').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-pane').forEach(t => t.classList.remove('show', 'active'));
        
        // Add active class to Results tab and content
        resultsTab.classList.add('active');
        resultsPanel.classList.add('show', 'active');
    }
}

// Auto-submit form when number is entered
document.getElementById('searchNumber').addEventListener('input', function() {
    if (this.value) {
        document.getElementById('searchQuery').value = '';
    }
});

document.getElementById('searchQuery').addEventListener('input', function() {
    if (this.value) {
        document.getElementById('searchNumber').value = '';
    }
});

// Tab navigation with smooth transitions
document.addEventListener('DOMContentLoaded', function() {
    const tabs = document.querySelectorAll('[data-bs-toggle="tab"]');
    tabs.forEach(tab => {
        tab.addEventListener('click', function(e) {
            e.preventDefault();
            const target = this.getAttribute('data-bs-target');
            const tabContent = document.querySelector(target);
            
            // Remove active class from all tabs and content
            document.querySelectorAll('.nav-link').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-pane').forEach(t => t.classList.remove('show', 'active'));
            
            // Add active class to clicked tab and content
            this.classList.add('active');
            tabContent.classList.add('show', 'active');
        });
    });
    
    // Auto-switch to Results tab if there are search results or show_all is requested
    {% if query or number or show_all or status %}
        const searchResults = document.querySelector('#results-panel .table-responsive');
        const hasResults = searchResults && searchResults.querySelector('tbody tr');
        
        if (hasResults || '{{ show_all }}' || '{{ status }}') {
            // Switch to Results tab
            const resultsTab = document.querySelector('#results-tab');
            const resultsPanel = document.querySelector('#results-panel');
            
            if (resultsTab && resultsPanel) {
                // Remove active class from all tabs and content
                document.querySelectorAll('.nav-link').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-pane').forEach(t => t.classList.remove('show', 'active'));
                
                // Add active class to Results tab and content
                resultsTab.classList.add('active');
                resultsPanel.classList.add('show', 'active');
            }
        }
    {% endif %}
});
</script>
{% endblock %} 